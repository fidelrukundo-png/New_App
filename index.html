<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#080810">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Fidel's Finances">
<title>Fidel's Finances</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080810;
    --surface: #10101c;
    --surface2: #18182a;
    --border: #25253a;
    --need: #00d4aa;
    --want: #ff6b6b;
    --save: #f5c542;
    --income: #7eb8ff;
    --accent: #9b87ff;
    --text: #eeeeff;
    --muted: #5a5a7a;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    max-width: 430px;
    margin: 0 auto;
    padding-bottom: 110px;
  }

  /* Header */
  .header {
    padding: 44px 22px 16px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .app-name {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 900;
    letter-spacing: -0.5px;
    line-height: 1;
  }

  .app-name span { color: var(--accent); }

  .app-sub {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 2.5px;
    text-transform: uppercase;
    margin-top: 5px;
  }

  .month-nav { display: flex; align-items: center; gap: 10px; margin-top: 4px; }

  .month-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    width: 34px; height: 34px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
    display: flex; align-items: center; justify-content: center;
  }
  .month-btn:active { background: var(--border); }

  .month-label {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 1px;
    min-width: 96px;
    text-align: center;
  }

  /* Balance Card */
  .balance-card {
    margin: 8px 20px 16px;
    background: linear-gradient(140deg, #141428 0%, #1a1a3a 60%, #12122a 100%);
    border: 1px solid #2a2a50;
    border-radius: 22px;
    padding: 26px 22px 22px;
    position: relative;
    overflow: hidden;
  }

  .balance-card::after {
    content: '';
    position: absolute;
    top: -60px; right: -60px;
    width: 200px; height: 200px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(155,135,255,0.12) 0%, transparent 65%);
    pointer-events: none;
  }

  .balance-label { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }

  .balance-amount {
    font-family: 'Playfair Display', serif;
    font-size: 36px;
    font-weight: 700;
    letter-spacing: -1px;
    margin-bottom: 20px;
    line-height: 1;
  }

  .balance-amount.pos { color: var(--need); }
  .balance-amount.neg { color: var(--want); }

  .balance-row { display: flex; gap: 8px; }

  .bstat {
    flex: 1;
    background: rgba(255,255,255,0.04);
    border-radius: 12px;
    padding: 10px 10px;
  }

  .bstat-lbl {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 4px;
    display: flex; align-items: center; gap: 5px;
  }

  .dot { width: 5px; height: 5px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
  .d-income  { background: var(--income); }
  .d-expense { background: var(--want); }
  .d-save    { background: var(--save); }

  .bstat-val { font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; }
  .bstat-val.income  { color: var(--income); }
  .bstat-val.expense { color: var(--want); }
  .bstat-val.save    { color: var(--save); }

  /* 50/30/20 Panel */
  .allocation-panel {
    margin: 0 20px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
  }

  .alloc-header {
    padding: 14px 18px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .alloc-title { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }

  .alloc-rule {
    font-size: 11px; color: var(--accent); font-weight: 700;
    background: rgba(155,135,255,0.1); padding: 3px 10px; border-radius: 99px;
    letter-spacing: 1px;
  }

  .alloc-rows { padding: 14px 18px 16px; display: flex; flex-direction: column; gap: 14px; }

  .alloc-row { display: flex; flex-direction: column; gap: 5px; }

  .alloc-top { display: flex; justify-content: space-between; align-items: center; }

  .alloc-name {
    font-size: 13px; font-weight: 600;
    display: flex; align-items: center; gap: 7px;
  }

  .alloc-badge { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 700; letter-spacing: 0.5px; }
  .badge-need { background: rgba(0,212,170,0.12); color: var(--need); }
  .badge-want { background: rgba(255,107,107,0.12); color: var(--want); }
  .badge-save { background: rgba(245,197,66,0.12); color: var(--save); }

  .alloc-right { text-align: right; }

  .alloc-spent { font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; }
  .alloc-spent.need { color: var(--need); }
  .alloc-spent.want { color: var(--want); }
  .alloc-spent.save { color: var(--save); }

  .alloc-target { font-size: 10px; color: var(--muted); margin-top: 1px; }

  .alloc-bar-bg { height: 6px; background: var(--surface2); border-radius: 99px; overflow: hidden; }

  .alloc-bar-fill { height: 100%; border-radius: 99px; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
  .alloc-bar-fill.need { background: linear-gradient(90deg, #00b899, var(--need)); }
  .alloc-bar-fill.want { background: linear-gradient(90deg, #e05050, var(--want)); }
  .alloc-bar-fill.save { background: linear-gradient(90deg, #d4a800, var(--save)); }
  .alloc-bar-fill.over { background: linear-gradient(90deg, var(--want), #ff3355) !important; }

  .alloc-status { font-size: 10px; font-weight: 500; }
  .status-ok   { color: var(--need); }
  .status-warn { color: var(--save); }
  .status-over { color: var(--want); }
  .status-none { color: var(--muted); }

  /* Category Breakdown */
  .chart-wrap {
    margin: 0 20px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px 18px;
  }

  .chart-title { font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 14px; }

  .cat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .cat-row:last-child { margin-bottom: 0; }
  .cat-row-icon { font-size: 16px; }
  .cat-bar-wrap { flex: 1; }
  .cat-bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
  .cat-bar-label span:last-child { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); }
  .cat-bar-bg { height: 4px; background: var(--surface2); border-radius: 99px; overflow: hidden; }
  .cat-bar-fill { height: 100%; border-radius: 99px; background: var(--want); }

  /* Filter tabs */
  .filter-tabs {
    display: flex; gap: 7px;
    padding: 0 20px; margin-bottom: 12px;
    overflow-x: auto; scrollbar-width: none;
  }
  .filter-tabs::-webkit-scrollbar { display: none; }

  .filter-tab {
    padding: 6px 13px; border-radius: 99px; font-size: 12px;
    cursor: pointer; background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); white-space: nowrap; transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }
  .filter-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Transactions */
  .section-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 20px; margin-bottom: 10px;
  }

  .section-title { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; }

  .transactions { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }

  .transaction-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 13px 14px;
    display: flex; align-items: center; gap: 12px;
    position: relative; transition: transform 0.15s;
  }
  .transaction-item:active { transform: scale(0.98); }

  .tx-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .tx-info { flex: 1; min-width: 0; }
  .tx-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tx-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; font-size: 11px; color: var(--muted); margin-top: 2px; }

  .tx-amount { font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; flex-shrink: 0; }
  .tx-amount.income  { color: var(--income); }
  .tx-amount.expense { color: var(--want); }
  .tx-amount.saving  { color: var(--save); }

  .tx-delete {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    background: rgba(255,107,107,0.15); border: none; color: var(--want);
    width: 28px; height: 28px; border-radius: 8px; cursor: pointer;
    display: none; align-items: center; justify-content: center; font-size: 13px;
  }
  .transaction-item.delete-mode .tx-delete  { display: flex; }
  .transaction-item.delete-mode .tx-amount  { opacity: 0; }

  .nw-badge { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 99px; letter-spacing: 0.5px; text-transform: uppercase; }
  .nw-badge.need   { background: rgba(0,212,170,0.12); color: var(--need); }
  .nw-badge.want   { background: rgba(255,107,107,0.12); color: var(--want); }
  .nw-badge.saving { background: rgba(245,197,66,0.12);  color: var(--save); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* Bottom Nav */
  .bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 430px;
    background: rgba(8,8,16,0.93); backdrop-filter: blur(24px);
    border-top: 1px solid var(--border);
    padding: 10px 16px 28px; display: flex; gap: 7px;
  }

  .add-btn {
    flex: 1; padding: 13px 6px; border-radius: 14px;
    font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600;
    cursor: pointer; border: 1px solid;
    transition: transform 0.15s;
  }
  .add-btn:active { transform: scale(0.96); }
  .btn-income  { background: rgba(126,184,255,0.1); color: var(--income); border-color: rgba(126,184,255,0.25); }
  .btn-expense { background: rgba(255,107,107,0.1); color: var(--want);   border-color: rgba(255,107,107,0.25); }
  .btn-save    { background: rgba(245,197,66,0.1);  color: var(--save);   border-color: rgba(245,197,66,0.25); }

  .del-btn {
    padding: 13px 14px; border-radius: 14px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); cursor: pointer; font-size: 16px; transition: background 0.2s;
  }
  .del-btn.active { background: rgba(255,107,107,0.15); border-color: rgba(255,107,107,0.3); color: var(--want); }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.78);
    display: none; align-items: flex-end; justify-content: center;
    z-index: 100; backdrop-filter: blur(6px);
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 24px 24px 0 0;
    padding: 26px 22px 40px; width: 100%; max-width: 430px;
    animation: slideUp 0.3s cubic-bezier(0.4,0,0.2,1);
    max-height: 92vh; overflow-y: auto;
  }

  @keyframes slideUp {
    from { transform: translateY(100%); opacity: 0; }
    to   { transform: translateY(0); opacity: 1; }
  }

  .modal-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; margin-bottom: 20px; }
  .modal-title.income  { color: var(--income); }
  .modal-title.expense { color: var(--want); }
  .modal-title.saving  { color: var(--save); }

  .form-group { margin-bottom: 14px; }

  label { display: block; font-size: 10px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 7px; }

  input, select {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 13px 15px; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 16px; outline: none;
    appearance: none; transition: border-color 0.2s;
  }
  input:focus, select:focus { border-color: var(--accent); }

  /* Need / Want toggle */
  .nw-toggle {
    display: flex; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
  }

  .nw-btn {
    flex: 1; padding: 11px 0; border: none; background: transparent;
    color: var(--muted); font-family: 'DM Sans', sans-serif;
    font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;
  }
  .nw-btn.active-need { background: rgba(0,212,170,0.15); color: var(--need); font-weight: 700; }
  .nw-btn.active-want { background: rgba(255,107,107,0.15); color: var(--want); font-weight: 700; }

  /* Category grid */
  .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 7px; }

  .cat-chip {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 4px; cursor: pointer; text-align: center;
    font-size: 10px; color: var(--muted); transition: all 0.18s;
    display: flex; flex-direction: column; align-items: center; gap: 4px;
  }
  .cat-chip .cat-emoji { font-size: 20px; }
  .cat-chip.selected { border-color: var(--accent); background: rgba(155,135,255,0.14); color: var(--text); }

  /* Save hint */
  .save-hint {
    background: rgba(245,197,66,0.08); border: 1px solid rgba(245,197,66,0.22);
    border-radius: 10px; padding: 10px 14px; font-size: 12px; color: var(--save);
    margin-bottom: 14px; display: none; line-height: 1.5;
  }

  .modal-actions { display: flex; gap: 10px; margin-top: 22px; }

  .btn-cancel {
    flex: 1; padding: 14px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; color: var(--muted); font-family: 'DM Sans', sans-serif;
    font-size: 15px; cursor: pointer;
  }

  .btn-submit {
    flex: 2; padding: 14px; border: none; border-radius: 12px;
    font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer;
  }
  .btn-submit.income  { background: var(--income); color: #050a18; }
  .btn-submit.expense { background: var(--want);   color: #fff; }
  .btn-submit.saving  { background: var(--save);   color: #1a1200; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div>
    <div class="app-name">Fidel's <span>Finances</span></div>
    <div class="app-sub">50 Â· 30 Â· 20 Method</div>
  </div>
  <div class="month-nav">
    <button class="month-btn" onclick="changeMonth(-1)">â€¹</button>
    <div class="month-label" id="monthLabel"></div>
    <button class="month-btn" onclick="changeMonth(1)">â€º</button>
  </div>
</div>

<!-- Balance Card -->
<div class="balance-card">
  <div class="balance-label">Net Balance</div>
  <div class="balance-amount pos" id="balanceAmount">RWF 0</div>
  <div class="balance-row">
    <div class="bstat">
      <div class="bstat-lbl"><span class="dot d-income"></span>Income</div>
      <div class="bstat-val income" id="totalIncome">RWF 0</div>
    </div>
    <div class="bstat">
      <div class="bstat-lbl"><span class="dot d-expense"></span>Spent</div>
      <div class="bstat-val expense" id="totalExpense">RWF 0</div>
    </div>
    <div class="bstat">
      <div class="bstat-lbl"><span class="dot d-save"></span>Saved</div>
      <div class="bstat-val save" id="totalSaved">RWF 0</div>
    </div>
  </div>
</div>

<!-- 50/30/20 Allocation Panel -->
<div class="allocation-panel">
  <div class="alloc-header">
    <div class="alloc-title">Income Allocation</div>
    <div class="alloc-rule">50 Â· 30 Â· 20</div>
  </div>
  <div class="alloc-rows">

    <div class="alloc-row">
      <div class="alloc-top">
        <div class="alloc-name">ðŸ§¾ Needs <span class="alloc-badge badge-need">50%</span></div>
        <div class="alloc-right">
          <div class="alloc-spent need" id="needSpent">RWF 0</div>
          <div class="alloc-target" id="needTarget">of RWF 0 target</div>
        </div>
      </div>
      <div class="alloc-bar-bg"><div class="alloc-bar-fill need" id="needBar" style="width:0%"></div></div>
      <div class="alloc-status status-none" id="needStatus">Add income to see targets</div>
    </div>

    <div class="alloc-row">
      <div class="alloc-top">
        <div class="alloc-name">ðŸŽ‰ Wants <span class="alloc-badge badge-want">30%</span></div>
        <div class="alloc-right">
          <div class="alloc-spent want" id="wantSpent">RWF 0</div>
          <div class="alloc-target" id="wantTarget">of RWF 0 target</div>
        </div>
      </div>
      <div class="alloc-bar-bg"><div class="alloc-bar-fill want" id="wantBar" style="width:0%"></div></div>
      <div class="alloc-status status-none" id="wantStatus">Add income to see targets</div>
    </div>

    <div class="alloc-row">
      <div class="alloc-top">
        <div class="alloc-name">ðŸ’° Savings <span class="alloc-badge badge-save">20%</span></div>
        <div class="alloc-right">
          <div class="alloc-spent save" id="saveSpent">RWF 0</div>
          <div class="alloc-target" id="saveTarget">of RWF 0 target</div>
        </div>
      </div>
      <div class="alloc-bar-bg"><div class="alloc-bar-fill save" id="saveBar" style="width:0%"></div></div>
      <div class="alloc-status status-none" id="saveStatus">Add income to see targets</div>
    </div>

  </div>
</div>

<!-- Category Breakdown -->
<div class="chart-wrap">
  <div class="chart-title">Spending by Category</div>
  <div id="categoryBreakdown">
    <div style="text-align:center;color:var(--muted);font-size:13px;padding:8px 0">No expenses yet</div>
  </div>
</div>

<!-- Filters -->
<div class="filter-tabs">
  <button class="filter-tab active" onclick="setFilter('all',this)">All</button>
  <button class="filter-tab" onclick="setFilter('income',this)">Income</button>
  <button class="filter-tab" onclick="setFilter('expense',this)">Expenses</button>
  <button class="filter-tab" onclick="setFilter('saving',this)">Savings</button>
</div>

<!-- Transaction list -->
<div class="section-header">
  <div class="section-title">Transactions</div>
  <div style="font-size:11px;color:var(--muted)" id="txCount">0 items</div>
</div>
<div class="transactions" id="transactionList"></div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <button class="add-btn btn-income"  onclick="openModal('income')">+ Income</button>
  <button class="add-btn btn-expense" onclick="openModal('expense')">+ Expense</button>
  <button class="add-btn btn-save"    onclick="openModal('saving')">+ Save</button>
  <button class="del-btn" id="delModeBtn" onclick="toggleDeleteMode()">ðŸ—‘</button>
</div>

<!-- Add Transaction Modal -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-title" id="modalTitle">Add</div>

    <div class="save-hint" id="saveHint"></div>

    <div class="form-group">
      <label>Amount (RWF)</label>
      <input type="number" id="amountInput" placeholder="0" inputmode="numeric" step="1" min="0">
    </div>

    <div class="form-group">
      <label>Description</label>
      <input type="text" id="descInput" placeholder="e.g. Salary, Rent...">
    </div>

    <div class="form-group" id="needWantGroup" style="display:none">
      <label>Type</label>
      <div class="nw-toggle">
        <button type="button" class="nw-btn" id="needBtn" onclick="setNeedWant('need')">ðŸ§¾ Need</button>
        <button type="button" class="nw-btn" id="wantBtn" onclick="setNeedWant('want')">ðŸŽ‰ Want</button>
      </div>
    </div>

    <div class="form-group">
      <label>Category</label>
      <div class="category-grid" id="categoryGrid"></div>
    </div>

    <div class="form-group">
      <label>Date</label>
      <input type="date" id="dateInput">
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-submit income" id="submitBtn" onclick="addTransaction()">Add</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Categories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INCOME_CATS = [
  {emoji:'ðŸ’¼',name:'Salary'},    {emoji:'ðŸ’°',name:'Freelance'},
  {emoji:'ðŸ“ˆ',name:'Invest'},    {emoji:'ðŸŽ',name:'Gift'},
  {emoji:'ðŸ ',name:'Rental'},    {emoji:'ðŸ›’',name:'Refund'},
  {emoji:'ðŸ’³',name:'Bonus'},     {emoji:'âœ¨',name:'Other'}
];

// Needs: Rent, Food, Clothing, Cash Power, Water
const NEED_CATS = [
  {emoji:'ðŸ ',name:'Rent',       nw:'need'},
  {emoji:'ðŸ›’',name:'Food',       nw:'need'},
  {emoji:'ðŸ‘—',name:'Clothing',   nw:'need'},
  {emoji:'âš¡',name:'Cash Power', nw:'need'},
  {emoji:'ðŸ’§',name:'Water',      nw:'need'},
  {emoji:'ðŸ’Š',name:'Health',     nw:'need'},
  {emoji:'ðŸ“š',name:'Education',  nw:'need'},
];

// Wants: Fuel, Going Out, Shopping
const WANT_CATS = [
  {emoji:'â›½',name:'Fuel',       nw:'want'},
  {emoji:'ðŸŒ†',name:'Going Out',  nw:'want'},
  {emoji:'ðŸ›',name:'Shopping',   nw:'want'},
  {emoji:'ðŸŽ®',name:'Fun',        nw:'want'},
  {emoji:'âœˆï¸',name:'Travel',     nw:'want'},
  {emoji:'âœ¨',name:'Other',      nw:'want'},
];

const SAVING_CATS = [
  {emoji:'ðŸ¦',name:'Bank'},      {emoji:'ðŸ“±',name:'MoMo Save'},
  {emoji:'ðŸ“Š',name:'Invest'},    {emoji:'ðŸ¡',name:'Property'},
  {emoji:'ðŸŽ“',name:'Edu Fund'},  {emoji:'ðŸ›¡',name:'Emergency'},
  {emoji:'âœ¨',name:'Other'}
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentType   = 'income';
let selectedCat   = null;
let selectedNW    = '';
let deleteMode    = false;
let currentFilter = 'all';
let currentMonth, currentYear;

// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY = 'fidel_finances_v2';
function getData()        { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
function saveData(d)      { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function getKey()         { return `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`; }
function getMonthData()   { const d=getData(); return d[getKey()] || {transactions:[]}; }
function saveMonthData(m) { const d=getData(); d[getKey()]=m; saveData(d); }

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const now = new Date();
  currentMonth = now.getMonth();
  currentYear  = now.getFullYear();
  render();
}

function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth > 11) { currentMonth=0; currentYear++; }
  if (currentMonth < 0)  { currentMonth=11; currentYear--; }
  render();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('monthLabel').textContent = `${MONTHS[currentMonth]} ${currentYear}`;

  const md  = getMonthData();
  const txs = md.transactions || [];

  const income  = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const needs   = txs.filter(t=>t.type==='expense'&&t.needWant==='need').reduce((s,t)=>s+t.amount,0);
  const wants   = txs.filter(t=>t.type==='expense'&&t.needWant==='want').reduce((s,t)=>s+t.amount,0);
  const saved   = txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
  const expense = needs + wants;
  const balance = income - expense - saved;

  // Balance card
  document.getElementById('balanceAmount').textContent = fmt(balance);
  document.getElementById('balanceAmount').className   = 'balance-amount ' + (balance>=0?'pos':'neg');
  document.getElementById('totalIncome').textContent   = fmt(income);
  document.getElementById('totalExpense').textContent  = fmt(expense);
  document.getElementById('totalSaved').textContent    = fmt(saved);

  // Allocation rows (50/30/20)
  renderAlloc('need', needs, income*0.50, 'need');
  renderAlloc('want', wants, income*0.30, 'want');
  renderAlloc('save', saved, income*0.20, 'save');

  // Category breakdown
  const catMap = {};
  txs.filter(t=>t.type==='expense').forEach(t=>{
    if(!catMap[t.category]) catMap[t.category]={emoji:t.catEmoji,total:0};
    catMap[t.category].total += t.amount;
  });
  const cats   = Object.entries(catMap).sort((a,b)=>b[1].total-a[1].total);
  const maxCat = cats.length ? cats[0][1].total : 1;
  document.getElementById('categoryBreakdown').innerHTML = cats.length
    ? cats.map(([name,{emoji,total}])=>`
        <div class="cat-row">
          <div class="cat-row-icon">${emoji}</div>
          <div class="cat-bar-wrap">
            <div class="cat-bar-label"><span>${name}</span><span>${fmt(total)}</span></div>
            <div class="cat-bar-bg"><div class="cat-bar-fill" style="width:${total/maxCat*100}%"></div></div>
          </div>
        </div>`).join('')
    : '<div style="text-align:center;color:var(--muted);font-size:13px;padding:8px 0">No expenses yet</div>';

  // Transaction list
  let filtered = [...txs];
  if (currentFilter==='income')  filtered = filtered.filter(t=>t.type==='income');
  if (currentFilter==='expense') filtered = filtered.filter(t=>t.type==='expense');
  if (currentFilter==='saving')  filtered = filtered.filter(t=>t.type==='saving');
  filtered.sort((a,b)=>new Date(b.date)-new Date(a.date));

  document.getElementById('txCount').textContent = filtered.length + ' items';

  if (!filtered.length) {
    document.getElementById('transactionList').innerHTML = `
      <div class="empty-state"><div class="emoji">ðŸ“Š</div><p>No transactions yet.<br>Tap a button below to start!</p></div>`;
    return;
  }

  document.getElementById('transactionList').innerHTML = filtered.map(t=>{
    const iconBg = t.type==='income' ? 'rgba(126,184,255,0.1)'
                 : t.type==='saving' ? 'rgba(245,197,66,0.1)'
                 : 'rgba(255,107,107,0.1)';
    const sign   = (t.type==='income'||t.type==='saving') ? '+' : '-';
    const amtCls = t.type==='saving' ? 'saving' : t.type;
    const badge  = t.needWant
      ? `<span class="nw-badge ${t.needWant}">${t.needWant}</span>`
      : t.type==='saving'
        ? `<span class="nw-badge saving">savings</span>`
        : '';
    return `
      <div class="transaction-item${deleteMode?' delete-mode':''}" id="tx-${t.id}">
        <div class="tx-icon" style="background:${iconBg}">${t.catEmoji}</div>
        <div class="tx-info">
          <div class="tx-name">${t.desc}</div>
          <div class="tx-meta"><span>${t.category} Â· ${fmtDate(t.date)}</span>${badge}</div>
        </div>
        <div class="tx-amount ${amtCls}">${sign}${fmt(t.amount)}</div>
        <button class="tx-delete" onclick="deleteTx('${t.id}')">âœ•</button>
      </div>`;
  }).join('');
}

function renderAlloc(key, spent, target, cls) {
  const rawPct = target > 0 ? (spent/target)*100 : 0;
  const pct    = Math.min(rawPct, 100);
  const rem    = target - spent;
  const over   = rawPct > 100;

  document.getElementById(key+'Spent').textContent  = fmt(spent);
  document.getElementById(key+'Target').textContent = `of ${fmt(target)} target`;

  const bar = document.getElementById(key+'Bar');
  bar.style.width = pct + '%';
  bar.className   = 'alloc-bar-fill ' + cls + (over ? ' over' : '');

  const st = document.getElementById(key+'Status');
  if (target === 0) {
    st.textContent = 'Add income to see your targets';
    st.className   = 'alloc-status status-none';
  } else if (over) {
    st.textContent = `âš  Over by ${fmt(Math.abs(rem))} (${Math.round(rawPct-100)}% excess)`;
    st.className   = 'alloc-status status-over';
  } else if (rawPct >= 80) {
    st.textContent = `${fmt(rem)} remaining â€” approaching limit`;
    st.className   = 'alloc-status status-warn';
  } else {
    st.textContent = `${fmt(rem)} remaining (${Math.round(100-rawPct)}% left)`;
    st.className   = 'alloc-status status-ok';
  }
}

// â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n)    { return 'RWF '+Math.round(Math.abs(n)).toLocaleString('en-US'); }
function fmtDate(d){ return new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}); }

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(type) {
  currentType = type;
  selectedCat = null;
  selectedNW  = '';

  document.getElementById('amountInput').value = '';
  document.getElementById('descInput').value   = '';
  document.getElementById('dateInput').value   = new Date().toISOString().split('T')[0];

  const title = document.getElementById('modalTitle');
  const sub   = document.getElementById('submitBtn');

  if (type==='income')  { title.textContent='+ Add Income';  title.className='modal-title income';  sub.className='btn-submit income'; }
  if (type==='expense') { title.textContent='+ Add Expense'; title.className='modal-title expense'; sub.className='btn-submit expense'; }
  if (type==='saving')  { title.textContent='+ Add Savings'; title.className='modal-title saving';  sub.className='btn-submit saving'; }

  // Savings hint
  const hint = document.getElementById('saveHint');
  if (type==='saving') {
    const txs     = (getMonthData().transactions || []);
    const inc     = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const already = txs.filter(t=>t.type==='saving').reduce((s,t)=>s+t.amount,0);
    const suggest = Math.max(0, Math.round(inc*0.20) - already);
    hint.innerHTML  = `ðŸ’¡ Your 20% savings target this month is <strong>${fmt(Math.round(inc*0.20))}</strong>. You still need to save <strong>${fmt(suggest)}</strong>.`;
    hint.style.display = 'block';
  } else {
    hint.style.display = 'none';
  }

  // Need/Want toggle â€” expenses only
  document.getElementById('needWantGroup').style.display = type==='expense' ? 'block' : 'none';
  document.getElementById('needBtn').className = 'nw-btn';
  document.getElementById('wantBtn').className = 'nw-btn';

  // Default category list
  let cats = type==='income' ? INCOME_CATS
           : type==='saving' ? SAVING_CATS
           : NEED_CATS;
  renderCats(cats);

  document.getElementById('addModal').classList.add('open');
  setTimeout(()=>document.getElementById('amountInput').focus(), 300);
}

function renderCats(cats) {
  const grid = document.getElementById('categoryGrid');
  grid.innerHTML = cats.map((c, i) =>
    `<div class="cat-chip" data-index="${i}">
      <span class="cat-emoji">${c.emoji}</span>
      <span>${c.name}</span>
    </div>`
  ).join('');

  // Attach click listeners using the cats array (avoids emoji/quote issues in onclick)
  grid.querySelectorAll('.cat-chip').forEach((el, i) => {
    el.addEventListener('click', () => {
      grid.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      selectedCat = { name: cats[i].name, emoji: cats[i].emoji };
      // For expenses, auto-highlight Need/Want toggle but DON'T re-render the chips
      if (cats[i].nw && currentType === 'expense') {
        highlightNW(cats[i].nw);
        selectedNW = cats[i].nw;
      }
    });
  });
}

function highlightNW(val) {
  document.getElementById('needBtn').className = 'nw-btn' + (val === 'need' ? ' active-need' : '');
  document.getElementById('wantBtn').className = 'nw-btn' + (val === 'want' ? ' active-want' : '');
}

function setNeedWant(val) {
  selectedNW  = val;
  selectedCat = null;
  highlightNW(val);
  // Swap category chips to match the chosen type
  renderCats(val === 'need' ? NEED_CATS : WANT_CATS);
}

function closeModal() { document.getElementById('addModal').classList.remove('open'); }

function addTransaction() {
  const amount = parseFloat(document.getElementById('amountInput').value);
  const desc   = document.getElementById('descInput').value.trim();
  const date   = document.getElementById('dateInput').value;

  if (!amount||amount<=0) { document.getElementById('amountInput').focus(); return; }
  if (!desc)              { document.getElementById('descInput').focus(); return; }
  if (!selectedCat)       { alert('Please select a category'); return; }
  if (currentType==='expense'&&!selectedNW) { alert('Please select Need or Want'); return; }

  const md = getMonthData();
  md.transactions = md.transactions||[];
  md.transactions.push({
    id:       Date.now().toString(),
    type:     currentType,
    amount,
    desc,
    category: selectedCat.name,
    catEmoji: selectedCat.emoji,
    needWant: currentType==='expense' ? selectedNW : null,
    date
  });
  saveMonthData(md);
  closeModal();
  render();
}

function deleteTx(id) {
  const md = getMonthData();
  md.transactions = md.transactions.filter(t=>t.id!==id);
  saveMonthData(md);
  render();
}

function toggleDeleteMode() {
  deleteMode = !deleteMode;
  document.getElementById('delModeBtn').classList.toggle('active', deleteMode);
  render();
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  render();
}

// Close modal on backdrop tap
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click', function(e){ if(e.target===this) this.classList.remove('open'); });
});

init();
</script>
<script>
// Register service worker - required for PWA/offline support
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js', { scope: './' })
      .then(function(reg) {
        console.log('Service Worker registered. Scope:', reg.scope);
      })
      .catch(function(err) {
        console.warn('Service Worker registration failed:', err);
      });
  });
}
</script>
</body>
</html>
